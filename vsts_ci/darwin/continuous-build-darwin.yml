steps:
  - task: UsePythonVersion@0
    displayName: "Use Python 2.7"
    inputs:
      versionSpec: 2.7
      addToPath: true
      architecture: "x64"

  - script: |
      sudo hostname "factoryvm-az131.k4f5cmcwetvejmwckdrrq50bfc.hx.internal.cloudapp.net"
      hostname
      az extension add --name azure-cli-iot-ext
      az --version
    displayName: "Install Azure Cli iot extension"

  - script: |
      pip install --upgrade pip
      pip install --upgrade tox
    displayName: "Update and install required tools"

  - script: |
      brew install docker
      brew install docker-machine
      brew link --overwrite docker-machine
      brew unlink docker-machine-driver-xhyve
      brew install docker-machine-driver-xhyve
      sudo chown root:wheel $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve
      sudo chmod u+s $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve
      mkdir -p /Users/vsts/.docker/machine/cache
      curl -Lo /Users/vsts/.docker/machine/cache/boot2docker.iso https://github.com/boot2docker/boot2docker/releases/download/v18.06.1-ce/boot2docker.iso
      docker-machine create default --driver xhyve --xhyve-boot2docker-url /Users/vsts/.docker/machine/cache/boot2docker.iso
      docker-machine env default
      eval $(docker-machine env default)
      brew services start docker-machine
      brew install docker-compose
      docker version
      echo "testttttttttttttt"
      python --version
      pip install iotedgehubdev==0.5.0
      sudo `which iotedgehubdev` setup -c "HostName=iothubautotestneil.azure-devices.net;DeviceId=iotedgeautotestdevice01;SharedAccessKey=EnGFllslsinRPEUe37LzUvkUEuFTWoJItP1ln2t0gnc="
    displayName: "Install docker and run tests against iotedgehubdev source code with tox"
